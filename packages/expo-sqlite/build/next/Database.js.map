{"version":3,"file":"Database.js","sourceRoot":"","sources":["../../src/next/Database.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter, Subscription } from 'expo-modules-core';\n\nimport ExpoSQLite from './ExpoSQLiteNext';\nimport { BindParams, RunResult, Statement, VariadicBindParams } from './Statement';\n\nconst emitter = new EventEmitter(ExpoSQLite);\n\n/**\n * Options for opening a database.\n */\nexport interface OpenOptions {\n  /**\n   * Whether to enable the CR-SQLite extension.\n   * @default false\n   */\n  enableCRSQLite?: boolean;\n\n  /**\n   * Whether to call the `sqlite3_update_hook` function and enable the `onDatabaseChange` events.\n   * @default false\n   */\n  enableChangeListener?: boolean;\n}\n\n/**\n * A SQLite database.\n */\nexport class Database {\n  private databaseId: number = -1;\n\n  private constructor(\n    public readonly dbName: string,\n    private readonly options?: OpenOptions\n  ) {}\n  private async openAsync(): Promise<number> {\n    return await ExpoSQLite.openDatabaseAsync(this.dbName, this.options ?? {});\n  }\n\n  /**\n   * Open a database.\n   *\n   * @param dbName The name of the database file to open.\n   * @param options Open options.\n   * @returns Database object.\n   */\n  public static async openDatabaseAsync(dbName: string, options?: OpenOptions): Promise<Database> {\n    const db = new Database(dbName, options);\n    db.databaseId = await db.openAsync();\n    return db;\n  }\n\n  /**\n   * Delete a database file.\n   *\n   * @param dbName The name of the database file to delete.\n   */\n  public static async deleteDatabaseAsync(dbName: string): Promise<void> {\n    return await ExpoSQLite.deleteDatabaseAsync(dbName);\n  }\n\n  /**\n   * Synchronous call to return whether the database is currently in a transaction.\n   */\n  public isInTransaction(): boolean {\n    return ExpoSQLite.isInTransaction(this.databaseId);\n  }\n\n  /**\n   * Asynchronous call to return whether the database is currently in a transaction.\n   */\n  public async isInTransactionAsync(): Promise<boolean> {\n    return await ExpoSQLite.isInTransactionAsync(this.databaseId);\n  }\n\n  /**\n   * Close the database.\n   */\n  public async closeAsync(): Promise<void> {\n    await ExpoSQLite.closeDatabaseAsync(this.databaseId);\n  }\n\n  /**\n   * Execute all SQL queries in the supplied string.\n   * > Note: The queries are not escaped for you! Be careful when constructing your queries.\n   *\n   * @param source A string containing all the SQL queries.\n   */\n  public async execAsync(source: string): Promise<void> {\n    await ExpoSQLite.execAsync(this.databaseId, source);\n  }\n\n  /**\n   * Prepare a SQL statement.\n   *\n   * @param source A string containing the SQL query.\n   * @returns A `Statement` object.\n   */\n  public async prepareAsync(source: string): Promise<Statement> {\n    const statementId = await ExpoSQLite.prepareAsync(this.databaseId, source);\n    return new Statement(this.databaseId, statementId);\n  }\n\n  /**\n   * Execute a transaction and automatically commit/rollback based on the `txn` success.\n   *\n   * @param txn An async function to execute within a transaction.\n   */\n  public async transactionAsync(txn: () => Promise<void>): Promise<void> {\n    try {\n      await this.execAsync('BEGIN');\n      await txn();\n      await this.execAsync('COMMIT');\n    } catch (e) {\n      await this.execAsync('ROLLBACK');\n      throw e;\n    }\n  }\n\n  /**\n   * Add a listener for database changes.\n   * > Note: to enable this feature, you must set `enableChangeListener` to `true` when opening the database.\n   *\n   * @param listener A function that receives the `dbName`, `tableName` and `rowId` of the modified data.\n   * @returns A `Subscription` object that you can call `remove()` on when you would like to unsubscribe the listener.\n   */\n  addDatabaseChangeListener(\n    listener: (event: { dbName: string; tableName: string; rowId: number }) => void\n  ): Subscription {\n    return emitter.addListener('onDatabaseChange', listener);\n  }\n\n  //#region Statement API shorthands\n\n  /**\n   * Shorthand for `prepareAsync` and `Statement.runAsync`.\n   * Unlike `Statement.runAsync`, this method finalizes the statement after execution.\n   *\n   * @param source A string containing the SQL query.\n   * @param params Parameters to bind to the query.\n   */\n  public runAsync(source: string, ...params: VariadicBindParams): Promise<RunResult>;\n  public runAsync(source: string, params: BindParams): Promise<RunResult>;\n  public async runAsync(source: string, ...params: any[]): Promise<RunResult> {\n    const statement = await this.prepareAsync(source);\n    const result = await statement.runAsync(...params);\n    await statement.finalizeAsync();\n    return result;\n  }\n\n  /**\n   * Shorthand for `prepareAsync` and `Statement.getAsync`.\n   * Unlike `Statement.getAsync`, this method finalizes the statement after execution.\n   *\n   * @param source A string containing the SQL query.\n   * @param params Parameters to bind to the query.\n   */\n  public getAsync<T>(source: string, ...params: VariadicBindParams): Promise<T | null>;\n  public getAsync<T>(source: string, params: BindParams): Promise<T | null>;\n  public async getAsync<T>(source: string, ...params: any[]): Promise<T | null> {\n    const statement = await this.prepareAsync(source);\n    const result = await statement.getAsync<T>(...params);\n    await statement.finalizeAsync();\n    return result;\n  }\n\n  /**\n   * Shorthand for `prepareAsync` and `Statement.eachAsync`.\n   * Unlike `Statement.eachAsync`, this method finalizes the statement after execution.\n   *\n   * @param source A string containing the SQL query.\n   * @param params Parameters to bind to the query.\n   */\n  public eachAsync<T>(source: string, ...params: VariadicBindParams): AsyncIterableIterator<T>;\n  public eachAsync<T>(source: string, params: BindParams): AsyncIterableIterator<T>;\n  public async *eachAsync<T>(source: string, ...params: any[]): AsyncIterableIterator<T> {\n    const statement = await this.prepareAsync(source);\n    yield* statement.eachAsync<T>(...params);\n    await statement.finalizeAsync();\n  }\n\n  /**\n   * Shorthand for `prepareAsync` and `Statement.allAsync`.\n   * Unlike `Statement.allAsync`, this method finalizes the statement after execution.\n   *\n   * @param source A string containing the SQL query.\n   * @param params Parameters to bind to the query.\n   */\n  public allAsync<T>(source: string, ...params: VariadicBindParams): Promise<T[]>;\n  public allAsync<T>(source: string, params: BindParams): Promise<T[]>;\n  public async allAsync<T>(source: string, ...params: any[]): Promise<T[]> {\n    const statement = await this.prepareAsync(source);\n    const result = await statement.allAsync<T>(...params);\n    await statement.finalizeAsync();\n    return result;\n  }\n\n  //#endregion\n}\n\nexport const openDatabaseAsync = Database.openDatabaseAsync;\n\nexport const deleteDatabaseAsync = Database.deleteDatabaseAsync;\n"]}